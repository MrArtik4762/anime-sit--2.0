<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Theme Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            background: hsl(var(--surface));
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid hsl(var(--border));
            border-radius: 6px;
            background: hsl(var(--surface));
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: hsl(var(--text));
        }
        
        .test-description {
            margin-bottom: 15px;
            color: hsl(var(--text-muted));
        }
        
        .theme-toggle-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .current-theme {
            padding: 8px 12px;
            background: hsl(var(--muted));
            border-radius: 4px;
            font-family: monospace;
            color: hsl(var(--text));
        }
        
        .console-output {
            background: hsl(var(--surface));
            color: hsl(var(--text));
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid hsl(var(--border));
        }
        
        .test-button {
            padding: 8px 16px;
            background: hsl(var(--primary));
            color: hsl(var(--text-foreground));
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: hsl(var(--primary-hover));
        }
        
        .success {
            color: hsl(var(--green-500));
        }
        
        .error {
            color: hsl(var(--red-500));
        }
        
        .warning {
            color: hsl(var(--yellow-500));
        }
        
        .sample-text {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: hsl(var(--muted));
            color: hsl(var(--text));
        }
        
        .sample-border {
            padding: 10px;
            margin: 10px 0;
            border: 2px solid hsl(var(--border));
            border-radius: 4px;
            background: hsl(var(--surface));
            color: hsl(var(--text));
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">System Theme Test</h1>
        
        <div class="test-section">
            <div class="test-title">1. Current System Theme Detection</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã —Å–∏—Å—Ç–µ–º—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            </div>
            <div class="theme-toggle-container">
                <button id="themeToggle" aria-label="Toggle theme" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    <!-- ThemeToggle –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Å—é–¥–∞ -->
                </button>
                <div class="current-theme">Current: <span id="currentTheme">system</span></div>
                <div class="current-theme">System: <span id="systemTheme">detecting...</span></div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">2. Theme Appearance Test</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –≤ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ
            </div>
            <div class="sample-text">
                –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ
            </div>
            <div class="sample-border">
                –ü—Ä–∏–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –≥—Ä–∞–Ω–∏—Ü–µ–π –≤ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">3. System Theme Change Test</div>
            <div class="test-description">
                –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            </div>
            <button class="test-button" onclick="toggleSystemTheme()">Simulate System Theme Change</button>
            <div class="console-output" id="systemChangeOutput"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">4. localStorage Test</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–º—ã –∏–∑ localStorage
            </div>
            <button class="test-button" onclick="testLocalStorage()">Test localStorage</button>
            <div class="console-output" id="localStorageOutput"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">5. Manual Theme Switch Test</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏
            </div>
            <div class="theme-toggle-container">
                <button class="test-button" onclick="setTheme('system')">System</button>
                <button class="test-button" onclick="setTheme('light')">Light</button>
                <button class="test-button" onclick="setTheme('dark')">Dark</button>
            </div>
            <div class="console-output" id="manualSwitchOutput"></div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentTheme = 'system';
        let systemThemePrefersDark = false;
        let isSystemTheme = true;
        
        // –°–∏–º—É–ª—è—Ü–∏—è ThemeToggle –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        class MockThemeToggle {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.themes = ['system', 'light', 'dark'];
                this.currentThemeIndex = 0;
                this.isClicking = false;
                this.icons = {
                    system: 'üíª',
                    light: '‚òÄÔ∏è',
                    dark: 'üåô'
                };
                this.render();
            }
            
            cycleTheme() {
                if (this.isClicking) return;
                
                this.isClicking = true;
                
                try {
                    this.currentThemeIndex = (this.currentThemeIndex + 1) % this.themes.length;
                    const newTheme = this.themes[this.currentThemeIndex];
                    
                    console.log('ThemeToggle clicked - new theme:', newTheme);
                    this.render();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    currentTheme = newTheme;
                    isSystemTheme = newTheme === 'system';
                    updateThemeDisplay();
                    applyTheme(newTheme);
                    
                    return newTheme;
                } catch (error) {
                    console.error('Error in ThemeToggle:', error);
                } finally {
                    setTimeout(() => {
                        this.isClicking = false;
                    }, 300);
                }
            }
            
            render() {
                const currentTheme = this.themes[this.currentThemeIndex];
                const icon = this.icons[currentTheme];
                const color = this.getThemeColor(currentTheme);
                
                this.container.innerHTML = `
                    <button 
                        onclick="themeToggle.cycleTheme()" 
                        aria-label="Toggle theme" 
                        title="–¢–µ–º–∞: ${currentTheme}"
                        style="
                            padding: 8px;
                            border-radius: 6px;
                            border: 1px solid hsl(var(--border));
                            background: hsl(var(--surface));
                            cursor: ${this.isClicking ? 'not-allowed' : 'pointer'};
                            opacity: ${this.isClicking ? '0.75' : '1'};
                            transition: all 0.2s;
                        "
                    >
                        <span style="font-size: 20px; color: ${color};">${icon}</span>
                    </button>
                `;
            }
            
            getThemeColor(theme) {
                switch (theme) {
                    case 'system': return '#3b82f6';
                    case 'light': return '#eab308';
                    case 'dark': return '#d1d5db';
                    default: return '#000000';
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–º–æ–π
        function detectSystemTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            systemThemePrefersDark = prefersDark;
            document.getElementById('systemTheme').textContent = prefersDark ? 'dark' : 'light';
            return prefersDark ? 'dark' : 'light';
        }
        
        function applyTheme(theme) {
            const root = document.documentElement;
            const systemTheme = detectSystemTheme();
            const resolvedTheme = theme === 'system' ? systemTheme : theme;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
            root.setAttribute('data-theme', resolvedTheme);
            (root).style.colorScheme = resolvedTheme;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('theme', theme);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateThemeDisplay();
            
            // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            logOutput('systemChangeOutput', `Theme changed to: ${theme} (resolved: ${resolvedTheme})`, '');
        }
        
        function updateThemeDisplay() {
            document.getElementById('currentTheme').textContent = currentTheme;
        }
        
        function setTheme(theme) {
            currentTheme = theme;
            isSystemTheme = theme === 'system';
            themeToggle.currentThemeIndex = theme === 'system' ? 0 : theme === 'light' ? 1 : 2;
            themeToggle.render();
            applyTheme(theme);
            logOutput('manualSwitchOutput', `Manually set theme to: ${theme}`, '');
        }
        
        function toggleSystemTheme() {
            // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É –¥–ª—è —Ç–µ—Å—Ç–∞
            systemThemePrefersDark = !systemThemePrefersDark;
            
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Ç–µ–º–∞ - system, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (currentTheme === 'system') {
                applyTheme('system');
            }
            
            logOutput('systemChangeOutput', `System theme toggled to: ${systemThemePrefersDark ? 'dark' : 'light'}`, 'warning');
        }
        
        function testLocalStorage() {
            try {
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
                const testTheme = 'dark';
                localStorage.setItem('theme', testTheme);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const savedTheme = localStorage.getItem('theme');
                
                if (savedTheme === testTheme) {
                    logOutput('localStorageOutput', '‚úì localStorage test PASSED', 'success');
                } else {
                    logOutput('localStorageOutput', '‚úó localStorage test FAILED', 'error');
                }
                
                // –û—á–∏—Å—Ç–∫–∞
                localStorage.removeItem('theme');
                
            } catch (error) {
                logOutput('localStorageOutput', `‚úó localStorage test ERROR: ${error.message}`, 'error');
            }
        }
        
        function logOutput(elementId, message, type = '') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? `class="${type}"` : '';
            
            output.innerHTML += `<div ${className}>[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let themeToggle;
        
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ThemeToggle
            themeToggle = new MockThemeToggle('themeToggle');
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã –∏–∑ localStorage
            const savedTheme = localStorage.getItem('theme') || 'system';
            currentTheme = savedTheme;
            themeToggle.currentThemeIndex = savedTheme === 'system' ? 0 : savedTheme === 'light' ? 1 : 2;
            themeToggle.render();
            
            // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
            applyTheme(savedTheme);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                console.log('System theme changed:', e.matches ? 'dark' : 'light');
                if (currentTheme === 'system') {
                    applyTheme('system');
                }
                logOutput('systemChangeOutput', `System preference changed to: ${e.matches ? 'dark' : 'light'}`, 'warning');
            });
            
            console.log('System Theme Test initialized');
        });
    </script>
</body>
</html>